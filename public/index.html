<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp SaaS Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .card { border-radius: 15px; border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #qrcode img { margin: 0 auto; padding: 10px; background: white; border-radius: 10px; }
        .status-online { color: #25D366; font-weight: bold; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card p-4 text-center">
                <h2 class="mb-4">WhatsApp SaaS Bot</h2>
                
                <div class="mb-3">
                    <input type="email" id="userId" class="form-control" placeholder="Enter your email to start">
                    <button class="btn btn-success w-100 mt-2" onclick="startBot()">Connect WhatsApp</button>
                </div>

                <div id="statusArea" class="mb-3">
                    <span id="statusLabel" class="badge bg-secondary">Offline</span>
                    <p id="statusMsg" class="mt-2 small text-muted">Enter email and click connect</p>
                </div>

                <div id="qrcode" class="my-3 d-flex justify-content-center"></div>

                <hr>

                <div id="tools" style="display:none;">
                    <h5>Tools</h5>
                    <div class="input-group mb-3">
                        <input type="text" id="groupId" class="form-control" placeholder="Group ID (e.g. 12345@g.us)">
                        <button class="btn btn-outline-primary" onclick="extract()">Export CSV</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const socket = io();
    const qrcodeContainer = document.getElementById("qrcode");

    function startBot() {
        const userId = document.getElementById('userId').value;
        if(!userId) return alert("Email required");
        socket.emit('start-session', userId);
        document.getElementById('statusMsg').innerText = "Starting engine...";
    }

    function extract() {
        const userId = document.getElementById('userId').value;
        const groupId = document.getElementById('groupId').value;
        socket.emit('extract-members', { userId, groupId });
    }

    socket.on('qr', (qr) => {
        qrcodeContainer.innerHTML = "";
        new QRCode(qrcodeContainer, qr);
        document.getElementById('statusLabel').className = "badge bg-warning text-dark";
        document.getElementById('statusLabel').innerText = "Scan Required";
        document.getElementById('statusMsg').innerText = "Scan this code with your WhatsApp Link Devices";
    });

    socket.on('status', (msg) => {
        document.getElementById('statusMsg').innerText = msg;
        if(msg === "Bot Connected!") {
            document.getElementById('statusLabel').className = "badge bg-success";
            document.getElementById('statusLabel').innerText = "Online";
            document.getElementById('tools').style.display = "block";
            qrcodeContainer.innerHTML = "<h3>âœ… Successfully Linked</h3>";
        }
    });

    socket.on('download-csv', (payload) => {
        const blob = new Blob([payload.data], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${payload.groupName}.csv`;
        a.click();
    });
</script>
</body>
</html>